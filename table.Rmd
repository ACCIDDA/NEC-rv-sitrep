

```{r table, echo=FALSE, warning=FALSE}
kpi_hosp <- nhsn %>%
  group_by(abbreviation, location_name, disease) %>%
  slice_max(order_by = target_end_date, n = 1, with_ties = FALSE) %>%
  ungroup() %>%
  transmute(
    State   = location_name,
    Virus   = toupper(disease),
    `Hosp Week End` = as.character(target_end_date),
    `Latest Hosp Admissions (wk)` = ifelse(is.na(observation), NA, scales::comma(round(observation)))
  )

kpi_ed <- nssp %>%
  group_by(abbreviation, location_name, disease) %>%
  slice_max(order_by = week_end, n = 1, with_ties = FALSE) %>%
  ungroup() %>%
  transmute(
    State   = location_name,
    Virus   = toupper(disease),
    `ED Week End`   = as.character(week_end),
    `Latest ED % of visits` = ifelse(is.na(ed_pct), NA, scales::percent(ed_pct/100, accuracy = 0.1))
  )

# NHSN and NSSP latest available week ending dates
hosp_week_end <- unique(kpi_hosp$`Hosp Week End`)
  ed_week_end <- unique(kpi_ed$`ED Week End`)

kpi <- full_join(kpi_ed, kpi_hosp, by = c("State","Virus")) %>%
  arrange(State, Virus)

if (knitr::is_html_output()) {

  gt::gt(kpi) %>%
    gt::fmt_missing(everything(), missing_text = "â€”") %>%
    gt::tab_header(title = gt::md("**Current Situation (latest available week)**")) %>%
    gt::cols_hide(columns = c('Hosp Week End','ED Week End')) %>%
    gt::tab_footnote(
      footnote = gt::md(paste0("Latest hosp: ", paste(hosp_week_end, collapse=", "),
                               "; latest ED: ", paste(ed_week_end, collapse=", ")))
    )

} else {

  # PDF: kableExtra
  if (!requireNamespace("kableExtra", quietly = TRUE)) install.packages("kableExtra")
  library(kableExtra)

  kpi_pdf <- kpi %>% dplyr::select(-`Hosp Week End`, -`ED Week End`)

  knitr::kable(kpi_pdf, format = "latex", booktabs = TRUE,
               caption = "Current Situation (latest available week)") %>%
    kableExtra::kable_styling(latex_options = c("hold_position", "striped"), font_size = 10)
}

```

