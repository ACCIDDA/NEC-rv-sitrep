```{r timeseries-plot-nssp-by-disease, echo=FALSE, warning=FALSE, message=FALSE, results='asis'}

library(dplyr)
library(ggplot2)
library(lubridate)


# --- Prep recent/current slices (group-wise) for NSSP
nssp_recent <- nssp %>%
  group_by(abbreviation, disease) %>%
  filter(week_end >= (max(week_end) - weeks(weeks_back))) %>%
  ungroup()

# --- Prep last year's corresponding weeks (extend previous season end by one month)
nssp_last_raw <- nssp %>%
  group_by(abbreviation, disease) %>%
  filter(
    week_end >= (max(week_end) - weeks(weeks_back) - years(1)) &
      week_end <= (max(week_end) - years(1) + months(1))
  ) %>%
  ungroup()

# --- Shift last year's dates forward by 1 year so they overlay on the current x-axis
nssp_last_overlay <- nssp_last_raw %>%
  mutate(week_end = week_end + years(1))

# --- Combine and label
nssp_plot_data <- bind_rows(
  nssp_recent %>% mutate(season = "Current"),
  nssp_last_overlay %>% mutate(season = "Previous season")
) %>%
  mutate(
    disease_label = toupper(disease),
    state_label   = toupper(abbreviation)
  )

# --- Stable color per disease (same approach as NHSN figure)
diseases_to_plot <- sort(unique(nssp_plot_data$disease_label))
disease_cols <- setNames(okabe_ito[seq_along(diseases_to_plot)], diseases_to_plot)

plot_one_disease_nssp <- function(dz) {

  dz_col <- disease_cols[[dz]]

  ggplot(
    nssp_plot_data %>% filter(disease_label == dz),
    aes(x = week_end, y = ed_pct, linetype = season, alpha = season)
  ) +
    geom_line(linewidth = 1, color = dz_col) +
    geom_vline(xintercept = today, linetype = "dotted") +
    facet_wrap(~ state_label, scales = "fixed", ncol = 2) +
    scale_linetype_manual(
      name = NULL,
      values = c("Current" = "solid", "Previous season" = "dotted"),
      labels = c("Current" = "Current (2025-26)", "Previous season" = "Previous (2024-25)")
    ) +
    scale_alpha_manual(values = c("Current" = 1, "Previous season" = 0.7), guide = "none") +
    labs(
      title = dz,
      subtitle = "Percent of all Emergency Department Visits (NSSP)",
      x = NULL,
      y = "Percent of ED visits",
      caption = "Data source: National Syndromic Surveillance Program (NSSP)"
    ) +
    theme_minimal(base_size = 16) +
    theme(
      panel.grid.minor = element_blank(),
      panel.grid.major.x = element_line(linewidth = 0.3),
      panel.grid.major.y = element_line(linewidth = 0.3),
      strip.text = element_text(size = 14, face = "bold"),
      plot.title = element_text(size = 20, face = "bold"),
      plot.subtitle = element_text(size = 13),
      axis.title.y = element_text(size = 14),
      axis.text = element_text(size = 12),
      legend.position = "top",
      legend.text = element_text(size = 12)
    )
}

# --- Tabs header (INSERT HERE, replacing the old print loop)
cat('<ul class="nav nav-pills justify-content-center disease-tabs" role="tablist">')

for (i in seq_along(diseases_to_plot)) {
  active <- ifelse(i == 1, "active", "")
  cat(sprintf('
<li class="nav-item">
  <button class="nav-link %s" data-bs-toggle="pill"
          data-bs-target="#%s" type="button">
    %s
  </button>
</li>
', active, diseases_to_plot[i], toupper(diseases_to_plot[i])))
}

cat('</ul><div class="tab-content">')

# --- Tab panes + existing plots (one per disease)
for (i in seq_along(diseases_to_plot)) {
  active <- ifelse(i == 1, "show active", "")
  cat(sprintf('<div class="tab-pane fade %s" id="%s">', active, diseases_to_plot[i]))

  print(plot_one_disease_nssp(diseases_to_plot[i]))

  cat('</div>')
}

cat('</div>')


```

<div class="summary-box">
  <ul style="list-style-type: none; padding-left: 0;">
    <li>
        <p>
      This figure shows the state-level trends in the impact of respiratory virus activity on emergency department (ED) visits based on National Syndromic Surveillance Program (NSSP) data. The broad coverage of this emergency department sample helps to provide reasonable estimates of how much symptomatic illness each virus is causing in each state. The percentage of visits for each disease out of all ED visits is shown to allow comparability across time and across states despite different overall ED visit volume. Data from the previous season, represented with dotted lines, are also shown for comparison. The dashed black vertical line represents the current report date, but the most updated available data may not be as recent. <br>
      <b>
      Forecasts: <br>
      </b>
      Forecasts are not yet available for emergency department visits.
      </p>
      <ul>
      </ul>
    </li>
  </ul>
</div>

<br><br><br>

